name: Pull Request Quality Gates

on:
  pull_request:

env:
  POSTGRES_URL: postgresql://postgres:postgres@127.0.0.1:54322/postgres
  F3_DATA_WAREHOUSE_URL: postgresql://postgres:postgres@127.0.0.1:54322/postgres

jobs:
  format-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.2
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Format check
        run: pnpm run format:check

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.2
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm run lint

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.2
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm run typecheck

  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.2
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.2
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm run test

  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.2
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        id: coverage_metrics
        run: |
          set -euo pipefail
          mkdir -p coverage
          pnpm run test:coverage -- --coverageReporters=text --coverageReporters=json-summary 2>&1 | tee coverage/test-output.log

          if [ ! -f coverage/coverage-summary.json ]; then
            echo "coverage-summary.json not found. Ensure Jest is configured to output the json-summary reporter." >&2
            exit 1
          fi

          node <<'NODE' >> "$GITHUB_OUTPUT"
const fs = require('fs');
const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8')).total;
const fmt = (label, title) => `${title}: ${Number(summary[label].pct ?? 0).toFixed(2)}%`;
console.log(`lines=${fmt('lines', 'Lines')}`);
console.log(`statements=${fmt('statements', 'Statements')}`);
console.log(`functions=${fmt('functions', 'Functions')}`);
console.log(`branches=${fmt('branches', 'Branches')}`);
console.log(`lines_raw=${summary.lines.pct ?? 0}`);
NODE

      - name: Upload coverage artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage-reports-${{ github.run_number }}
          path: coverage
          if-no-files-found: warn
          retention-days: 30

      - name: Enforce minimum coverage
        env:
          MIN_COVERAGE: "70"
          LINES: ${{ steps.coverage_metrics.outputs.lines_raw }}
        run: |
          python3 - <<'PY'
import os
import sys

lines = os.environ.get("LINES")
threshold = float(os.environ["MIN_COVERAGE"])
if not lines:
    print("Unable to determine coverage percentage for enforcement.")
    sys.exit(1)

lines_value = float(lines)
if lines_value < threshold:
    print(f"Line coverage {lines_value:.2f}% is below the required {threshold:.2f}% minimum.")
    sys.exit(1)

print(f"Line coverage {lines_value:.2f}% meets the required {threshold:.2f}% minimum.")
PY

      - name: Comment coverage report on PR
        if: ${{ always() && github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = 'ðŸ“Š Test Coverage Report';
            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes(marker)
            );

            const coverageComment = `## ${marker}

**Repository:** ${{ github.repository }}
**Branch:** ${{ github.head_ref || github.ref_name }}
**Commit:** ${{ github.sha }}
**Status:** ${{ job.status }}

### Coverage Summary
- ${{ steps.coverage_metrics.outputs.lines }}
- ${{ steps.coverage_metrics.outputs.statements }}
- ${{ steps.coverage_metrics.outputs.functions }}
- ${{ steps.coverage_metrics.outputs.branches }}

### Links
- [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
- [Download Coverage Reports](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

---
*This report was automatically generated by GitHub Actions*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: coverageComment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: coverageComment,
              });
            }
